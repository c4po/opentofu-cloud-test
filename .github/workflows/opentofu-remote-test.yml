name: OpenTofu Remote Test

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  remote-backend-matrix:
    name: "Remote backend: ${{ matrix.scenario.name }}"
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "1"
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - name: "success"
            backend_config: "backend-config/success.hcl"
            expected: "success"
          - name: "wrong-org"
            backend_config: "backend-config/wrong-org.hcl"
            expected: "fail"
          - name: "wrong-workspace"
            backend_config: "backend-config/wrong-workspace.hcl"
            expected: "fail"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Authenticate with TFState Backend
        uses: actions/github-script@v6
        env:
          AUDIENCE: "https://tfdev.bonesoul.com"
          HOSTNAME: "tfdev.bonesoul.com"
        with:
          github-token: ${{ github.token }}
          script: |
            const aud = process.env.AUDIENCE;
            // 1. Request OIDC token from GitHub
            const id_token = await core.getIDToken(aud);
            
            // 2. Format the environment variable name: TF_TOKEN_hostname_com
            const hostname_clean = process.env.HOSTNAME.replace(/\./g, '_');
            const env_var_name = `TF_TOKEN_${hostname_clean}`;
            
            // 3. Export it as a secret for subsequent steps
            core.exportVariable(env_var_name, id_token);
            core.setSecret(id_token); // Mask in logs
            console.log(`Exported OIDC token to ${env_var_name}`);

      - name: Run OpenTofu (matrix scenario)
        run: |
          set -euo pipefail

          backend_config="${{ matrix.scenario.backend_config }}"
          expected="${{ matrix.scenario.expected }}"

          echo "Scenario: ${{ matrix.scenario.name }}"
          echo "Backend config: ${backend_config}"
          echo "Expected: ${expected}"

          set +e
          tofu init -reconfigure -input=false -backend-config="${backend_config}"
          init_rc=$?
          set -e

          if [ "${expected}" = "fail" ]; then
            if [ "$init_rc" -ne 0 ]; then
              echo "tofu init failed as expected (rc=$init_rc)"
              exit 0
            fi

            echo "WARNING: tofu init unexpectedly succeeded; verifying tofu apply fails..."
            set +e
            tofu apply -auto-approve -input=false
            apply_rc=$?
            set -e

            if [ "$apply_rc" -eq 0 ]; then
              echo "ERROR: tofu apply unexpectedly succeeded for an expected-fail scenario"
              exit 1
            fi

            echo "tofu apply failed as expected (rc=$apply_rc)"
            exit 0
          elif [ "${expected}" = "success" ]; then
            if [ "$init_rc" -ne 0 ]; then
              echo "ERROR: tofu init failed unexpectedly (rc=$init_rc)"
              exit 1
            fi
          else
            echo "ERROR: unknown expected value: '${expected}'"
            exit 1
          fi

          tofu apply -auto-approve -input=false
